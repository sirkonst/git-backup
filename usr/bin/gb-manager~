#!/bin/bash

. /etc/gb.conf

# $1 - имя конфига (пример: "etc.gb.conf")
__set_gb_env() {
	export GIT=${GIT:-/usr/bin/git}
	export ARCHIVES_BRANCH=${ARCHIVES_BRANCH:-master}
	export GIT_DIR="${GB_ARCHIVES_ROOT}/${1%.gb.conf}"
	. /etc/gb.d/$1
	export GIT_WORK_TREE=${GB_BACKUP_TARGET}
	export GB_MANAGER="true"
}

# Вывести список доступныйх целей:
_ls_targets() {
	echo "Список целей (название - исходная папка - архивная папка):"

	GBS=`ls /etc/gb.d/ | grep ".gb.conf$"`

	for x in $GBS ; do
		echo -e -n "\t* "
		echo -e -n "${x%.gb.conf} \t- "
		. /etc/gb.d/"$x"
		echo -n "${GB_BACKUP_TARGET} - "
		echo "${GB_ARCHIVES_ROOT}/${x%.gb.conf}"
	done
}

_backupall() {
	shift # $1 - opt daily or tag
	GBS=`ls /etc/gb.d/ | grep ".gb.conf$"`

	for x in $GBS ; do
		__set_gb_env "$x"

		cp /etc/gb.d/$x "${GIT_WORK_TREE}/.gb.conf"
		echo -e "\n# env" >> "${GIT_WORK_TREE}/.gb.conf"
		echo "GB_ARCHIVES_DIR=${GIT_DIR}" >> "${GIT_WORK_TREE}/.gb.conf"

		gb-backup backup $1

		cp /etc/gb.d/$x "${GIT_DIR}/.gb.conf"
		echo -e "\n# env" >> "${GIT_DIR}/.gb.conf"
		echo "GB_ARCHIVES_DIR=${GIT_DIR}" >> "${GIT_DIR}/.gb.conf"
	done
}

_help() {
	echo "Доступные команды:"
	echo -e "\t list"
	echo -e "\t backupall [daily|tag]"
}

# MAIN

case "$1" in
	"list"		)	_ls_targets;;
	"backupall"	)	_backupall $@;;
	"help"		)	_help;;
	 *		)	_help;;
esac


